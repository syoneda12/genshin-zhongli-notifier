/**
 * 原神デイリーノート通知（岩王帝君の余録・無題Ver.）
 * トリガー：1時間ごと
 */
function notifyGenshinDailyNote() {
  const hour = new Date().getHours();
  if (hour < START_HOUR || hour >= END_HOUR) {
    logMessage(`現在${hour}時：静寂の時間ゆえ、処理を行わない。`);
    return;
  }

  try {
    const data = fetchDailyNote();
    const lines = [];

    // 天然樹脂（2時間ごと）
    if ([8, 10, 12, 14, 16, 18, 20, 22].includes(hour)) {
      if (data.current_resin === data.max_resin) {
        lines.push("……天然樹脂は、すでに満ちているようだ。これ以上の蓄えは、無意味だな。");
      } else if (Number(data.resin_recovery_time) > 0) {
        lines.push(`天然樹脂は、あと${formatTime(data.resin_recovery_time)}で満ちるだろう。時を待つといい。`);
      }
    }

    // 洞天宝銭（3時間ごと）
    if ([9, 12, 15, 18, 21, 0].includes(hour)) {
      if (data.current_home_coin === data.max_home_coin) {
        lines.push("洞天宝銭が限界まで蓄えられている。富は扱いを誤れば、災いを招く。");
      } else if (Number(data.home_coin_recovery_time) > 0) {
        lines.push(`洞天宝銭は、あと${formatTime(data.home_coin_recovery_time)}で満ちるようだ。備えておくといい。`);
      }
    }

    // 探索派遣（4時間ごと）
    if ([7, 11, 15, 19, 23].includes(hour)) {
      if (Array.isArray(data.expeditions)) {
        const finished = data.expeditions.filter(e => e.status === "Finished").length;
        if (finished > 0) {
          lines.push(`探索派遣${finished}件が任を果たしたようだ。……労をねぎらうとしよう。`);
        }
      }
    }

    // 参量物質変化器（6時間ごと）
    if ([6, 12, 18, 0].includes(hour)) {
      if (data.transformer && data.transformer.recovery_time) {
        const { reached, Day, Hour, Minute, Second } = data.transformer.recovery_time;
        const recoveryTime = (Day * 24 * 60) + (Hour * 60) + Minute + (Second / 60);
        if (!reached && recoveryTime < 60) {
          lines.push(`参量物質変化器は、あと${Math.ceil(recoveryTime)}分で再び用いることができるだろう。`);
        } else if (reached) {
          lines.push("……参量物質変化器が再びその力を得たようだ。今が好機かもしれんな。");
        }
      }
    }

    // デイリー報酬（夜2回）
    if ([21, 23].includes(hour)) {
      if (!data.is_extra_task_reward_received) {
        lines.push("デイリー任務の報酬をまだ受け取っていないようだ。報酬は、受け取っておくといい。");
      }
    }

    // === ランダム余韻句 ===
    // 「璃月港の片隅…」「香の煙が…」など、詩的な情景描写を複数カテゴリで定義
    const headerGroups = {
      morning: [
          "朝靄の璃月港、船の帆が風に揺れている",
          "岩山の影が薄れ、金色の陽が港を照らし始める",
          "香炉の煙が淡く立ちのぼり、新しい一日を告げている",
          "港の市場が目を覚まし、商人たちの声がこだまする",
          "茶屋の扉が開き、湯気が朝日に透ける",
          "山鳥が鳴き、風が契約の国を駆け抜ける",
          "陽光が岩壁を染め、古き碑文が金に輝く",
          "水面に映る街の影が、静かに揺れている",
          "早朝の鐘が鳴り、璃月の街が動き出す",
          "新しい契約の香りが、潮風に混じる"
        ],
        day: [
          "岩の庇の下、茶の香が静かに満ちていく",
          "港の喧騒が広がり、モラの音が響く",
          "山頂の雲が流れ、龍の眠る峰が姿を見せた",
          "潮風が衣を撫で、陽光が海面を煌めかせる",
          "市場のざわめきが、璃月の活気を物語る",
          "職人たちの槌音が、岩の鼓動と重なり合う",
          "商船が港に戻り、新たな取引が始まる",
          "岩の国に、変わらぬ秩序が息づいている",
          "昼下がりの茶の湯が、静けさを取り戻す",
          "金の光が、山と海の狭間を満たしている"
        ],
        evening: [
          "夕暮れの港、子供たちの笑い声が遠く響く",
          "岩灯がともり、人々が一日の契約を終える",
          "山の端に日が沈み、港の灯がひとつまたひとつ灯る",
          "風鈴が鳴り、岩の街に夜が降りてくる",
          "茶屋の湯気が夕陽に染まり、柔らかな金に変わる",
          "潮の香と茶の香が交わる刻限だ",
          "赤く染まる雲が、岩のように空を支えている",
          "岩壁の影が伸び、港の喧騒が遠のく",
          "労を終えた民が、家路へと歩む足音が響く",
          "契約の国に、穏やかな静けさが戻る"
        ],
        night: [
          "月が昇り、波間に金色の光が漂う",
          "茶屋の灯りがゆらめき、静寂が璃月を包む",
          "岩笛の音が遠くで響き、夜が街を覆う",
          "灯籠が流れ、契約の誓いがひとつ届く",
          "潮風が頬を撫で、灯火が揺れている",
          "龍の影が山に眠り、風が古の名を呼ぶ",
          "星々が港を照らし、波がさざめく",
          "香の煙が静かに上り、夜空へと溶けていく",
          "港の音が遠ざかり、ただ岩の鼓動が残る",
          "静かな夜に、古き誓いがふたたび息づく"
        ],
        timeless: [
          "璃月港の片隅より、悠久の声が響く",
          "香の煙が輪を描き、やがて消える",
          "岩の庇の下、時が止まったように静かだ",
          "潮風が頬を撫で、契約の国は息づいている",
          "岩の影が伸び、永劫の理が語られている",
          "港の風が衣を揺らす。今日も変わらぬ風だ",
          "龍の眠る山影が、今日も街を見守っている",
          "灯籠が揺れ、古き歌が風に混じる",
          "香炉の灰が舞い、時の流れを示している",
          "港の片隅、誰かが小さく祈りを捧げている",
          "岩に刻まれた契約の印が、今も光を放つ",
          "街の灯が波に映り、千の星のように輝く",
          "山々の彼方に、悠久の声がこだまする",
          "静寂がすべてを包み、理が形を取る",
          "港の奥で、茶器の音が微かに響く",
          "霧の向こうに、金色の影が見える",
          "潮騒が心を鎮め、岩がその響きを返す",
          "龍の吐息のような風が、港を渡っていく",
          "岩壁に刻まれた言葉が、時を超えて語る",
          "静けさの中、香と茶が心を満たす",
          "璃月の空に、今日もまた金の光が差し込む"
        ]
    };
    // 時間帯に応じたheaderグループ選択（柔軟な拡張に対応）
    let selectedGroup = "timeless";
    if (hour >= 5 && hour < 10) selectedGroup = "morning";
    else if (hour >= 10 && hour < 17) selectedGroup = "day";
    else if (hour >= 17 && hour < 20) selectedGroup = "evening";
    else if (hour >= 20 || hour < 5) selectedGroup = "night";

    // 選択したグループからランダム選択、装飾を付与
    const headers = headerGroups[selectedGroup].map(line => `――${line}…`);
    //// headerグループを全結合して配列にまとめる
    //const headers = Object.values(headerGroups).flat().map(line => `――${line}…`);
    const header = headers[Math.floor(Math.random() * headers.length)];
    
    const prefaces = ["……"];
    const epilogues = [
      // "───璃月港の片隅より、悠久の声が響く",
      "岩の如き理が、今日もこの世を支えている",
      "時の流れは止まらぬが、契約は永遠だ",
      "黄金は輝きを失わぬ、心が濁らぬ限り",
      "この璃月、今日もまた穏やかであるように",
      // "嗚呼、悠久の時に刻まれる日常もまた、尊い",
      "岩の響きは静かに、しかし確かに続く",
      "さて……茶でも淹れるとしよう",
      
      "時は流れ、岩は留まる。真理とは、変わらぬものの中にある。",
      "契約とは、言葉ではなく心に刻むものだ。",
      "この世の理は、岩のように静かに形を保つ。",
      "人が契りを結ぶたびに、世界は少しだけ秩序を得る。",
      "約束を守る者、それがこの璃月を支える礎だ。",
      "理を知る者は慎みを知る。ゆえに岩は崩れぬ。",
      "璃月の人々の営みは、今日もまた静かに続いている。",
      "富も権も、民があってこそ価値を持つ。",
      "人の手で築かれた街こそ、真に尊い。",
      "香炉の煙が揺れるたび、昔の祭を思い出す。",
      "風は港を撫で、灯りは人を導く。",
      "千の契約を経ても、この岩の心は変わらぬ。",
      "昔日の戦を思えば、今の静けさは宝だ。",
      "龍としての時は過ぎ、人としての静けさを好む。",
      "岩の記憶は、誰よりも長く、正確だ。",
      "歴史は語らずとも刻まれる。岩に、そして心に。",
      "さて、茶の湯を淹れるにはちょうどよい刻限だ。",
      "茶と香を共に嗜めば、心も岩のように静まる。",
      "ふむ……この香り、かつての友を思い出す。",
      "話し相手がいれば、茶はさらに甘くなる。",
      "今宵もまた、静かに杯を傾けるとしよう。",
      "岩の響きは、誰もいなくとも止むことはない。",
      "静寂の中にこそ、真の豊かさがある。",
      "世の流れを見届けるのも、悪くはない。",
      "共に語らう者は減ったが、心は未だ賑やかだ。",
      "名もなき日常こそ、岩王帝君の安らぎなり。",
      "ふむ、茶を切らしたか。まこと、由々しき事態だ。",
      "モラを落とした？……それは一大事だな。",
      "もう少し若者たちを信じてみようか。",
      "岩は黙して語らず、だが見守っている。",
      "さて……茶でも淹れるとしよう。",

      "理は不変、されど人の心は移ろうものだ。",
      "契約とは、形ではなく信義の証なり。",
      "真理は岩のように、時を越えても変わらぬ。",
      "守る者あれば、世界は静かに廻る。",
      "秩序は強制にあらず、信頼により成る。",
      "約定を軽んずる者に、岩は微笑まぬ。",
      "法は岩のように堅くとも、人の手で磨かれるものだ。",
      "契約を結ぶたび、心の奥に新たな岩が積もる。",
      "約束を守る者、その歩みこそ尊い。",
      "理を悟れば、争う必要などないのだ。",
      "千年を経ても、この港の灯は変わらぬ。",
      "岩は朽ちず、記憶もまた風化せぬ。",
      "古き友の名を呼ぶ声は、今も山にこだまする。",
      "時は流れ、人は変わり、されど岩は見守り続ける。",
      "幾度の盛衰を経ても、璃月は立ち続けた。",
      "龍の爪跡はもう消えたが、風はあの日を覚えている。",
      "悠久とは退屈ではなく、学びの連なりだ。",
      "時間に抗うことは、岩に爪を立てるようなものだ。",
      "永劫の中でも、変わらぬ心がひとつあればよい。",
      "岩は時を語らず、ただ静かに記すのみ。",
      "民の笑い声こそ、璃月の財だ。",
      "人が働き、休み、語り合う──それで十分だ。",
      "今日も港の茶屋は賑やかだ。よい兆しだ。",
      "働く者には休息を。これもまた契約の一種だ。",
      "人の営みは儚くとも、美しい。",
      "若き者たちの声が、未来を形づくる。",
      "富を持つことより、分かち合う心を持て。",
      "何よりも尊いのは、変わらぬ誠実さだ。",
      "港の喧騒を聞けば、今日も璃月は安泰だと分かる。",
      "人の手で作られたものは、どれも愛おしい。",
      "……さて、そろそろ茶でも淹れるとしよう。",
      "香る湯気に、ひとときの安らぎを見つける。",
      "茶の味は、静けさを映す鏡のようだ。",
      "茶を淹れる時、人は神に最も近づく。",
      "ひと口の茶に、千の思い出が宿る。",
      "客人がいれば茶を、いなければ独り言を。",
      "……この香り、昔の友を思い出す。",
      "温かい茶は、冷えた心にも効く。",
      "茶器の欠けにも、時の味わいがある。",
      "ふむ、今日の茶は少し濃いな。だが悪くない。",
      "孤独とは贅沢な時間だ。恐れることはない。",
      "沈黙もまた、ひとつの対話だ。",
      "岩が語らぬのは、すべてを知っているからだ。",
      "誰かが去るたび、岩は少しだけ重くなる。",
      "静けさの中にこそ、真理が眠る。",
      "声がなくとも、思いは届くものだ。",
      "何もせぬことも、時に必要な選択だ。",
      "孤独を恐れぬ者だけが、世界を理解できる。",
      "夜が深まるほど、思考は透明になる。",
      "誰かに語ることより、自らに問うことの方が難しい。",
      "モラを落とした？……ふむ、それは重大な契約違反だ。",
      "あの若者たち、今日も元気だ。実に眩しい。",
      "仕事を忘れるほどの茶会……悪くない。",
      "近頃の料理人は、香辛料を惜しまぬようだな。",
      "どうやら、私はまた長話をしてしまったらしい。",
      "岩のように堅い決意も、時に柔らかくせねばな。",
      "ふむ、今日もモラが足りぬ。だが心は満ちている。",
      "契約違反者に説教をするのは、もはや趣味かもしれん。",
      "若者の夢を見るのは、悪くない気分だ。",
      "さて……今宵も璃月港の灯が美しい。もう一杯、茶を淹れよう。"
  
    ];
    const footer = epilogues[Math.floor(Math.random() * epilogues.length)];

    // === 通知 ===
    if (lines.length > 0) {
      const preface = prefaces[Math.floor(Math.random() * prefaces.length)];
      // const message = `${header}\n\n${lines.join("\n")}\n${preface}${footer}`;
      const message = `${lines.join("\n")}`;
      sendDiscordMessage(message);
    } else {
      logMessage(`現在${hour}時：通知対象なし。`);
    }

  } catch (e) {
    logMessage(`エラー発生: ${e.message}`);
    sendDiscordMessage(`……何か不具合が生じたようだ。原因を探るとしよう。\n${e.message}`);
  }
}